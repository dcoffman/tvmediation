---
title: "Time Varying Mediation Analysis"
author: "Donna L. Coffman"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Time Varying Mediation Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

<style>
pre {
  overflow-x: auto;
}
pre code {
  word-wrap: normal;
  white-space: pre;
}
</style>

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)  # NEED TO LOAD tidyverse BEFORE Hmisc!
library(Hmisc)
library(locpol)
library(tvmediation)
```

<div style="text-align: justify">

The purpose of this vignette is to provide users with a step-by-step guide for 
performing a time varying mediation analysis and interpreting the results. To illustrate we will used a simulated data set.



<!-- We will rely on the Wisconsin Smokers' Health Study 2 dataset which includes 1047  -->
<!-- individuals across 3 treatment conditions. In one condition, one-third of  -->
<!-- participants received only a nicotine patch. In a second condition, another  -->
<!-- one-third received a nicotine patch and varenicline. A final third of  -->
<!-- participants were placed into a third condition and received a nicotine patch  -->
<!-- as well as combination nicotine replacement therapy. The outcome variable of  -->
<!-- interest was how tired a participant felt of trying to quit smoking (7-point  -->
<!-- Likert scale). In addition, a mediator variable was collected by asking  -->
<!-- participants if they felt a negative mood in the last fifteen minutes. Both the  -->
<!-- outcome and mediator variables were assessed 2x per day over the course of  -->
<!-- twenty-eight days. A traditional approach to analyzing this type of data would  -->
<!-- utilize a mediation analysis. First, a single direct effect would be calculated  -->
<!-- by regressing the outcome on the treatment condition. Next, a single indirect  -->
<!-- effect would be computed by multiplying the effect of treatment condition on the  -->
<!-- mediator by the effect of the mediator on the outcome. However, we feel this  -->
<!-- method potentially misses important information about the dynamic effect that a  -->
<!-- mediator may have over time. Specifically, we hypothesize that mood changes and  -->
<!-- thus, its mediating effect on oneâ€™s feelings of quitting smoking is likely to  -->
<!-- vary. We therefore propose a time varying mediation analysis which estimates the  -->
<!-- mediation effect as a function that varies over time. -->

## Getting started

To use the time varying mediation analysis package in R, you must first install
it and load it: 
```{r, eval = FALSE}
devtools::install.packages("tvmediation")
library(tvmediation)
```

In addition, you will want to install the `locpol` package which is necessary
for certain functions in the `tvmediation` package.

Once installed, you can type `?tvmediation` in the console to view the package 
documentation, as well as links to the important functions and data included in 
the package. The `tvmediation` package relies on two user functions `tvma` and 
`LongToWide` as well as a number of internal functions. The dataset we will use 
for our example is named `smoker` and is also included in the package.

To load the `smoker` dataset, type:
```{r}
data(smoker)
```

## Using `tvmediation`

The current version of the `tvma` function only supports two treatment options. A separate function `tvma_3trt` for three treatment options is also available.

The `smoker` data frame is organized in Long format with `SubjectID` repeating
over multiple rows for each participant. the `tvma` function requires that our
data be in Wide format in order to accurately estimate the time varying mediator
coefficients. The `tvmediation` package includes a useful function `LongToWide` 
to help users properly format their data for analysis.

`LongToWide` has 3 main input arguments, and a fourth optional argument.

1. `subject.id` requires a column of subject identifiers. 
2. `time.sequences` requires a column of time points.
3. `outcome` requires a column of measures that are to be transposed.
4. `verbose` is an option that can be turned on to print the output of `LongToWide` to the console

The output of `LongToWide` is a matrix of data in wide format where columns 
represent time sequence and rows represent the outcome for each subject.

As the `tvma` function will require two matrices, one for mediators, and one for
outcomes, we will use the `LongToWide` function twice as seen below:
```{r}
mediator <- LongToWide(smoker$SubjectID, smoker$timeseq, smoker$NegMoodLst15min)
outcome <- LongToWide(smoker$SubjectID, smoker$timeseq, smoker$cessFatig)
mediator[, 1:10]
```

## Using `tvma`

To recap up to this point, we have loaded our data, created necessary variables, 
sorted the dataset, and generated matrices for our mediators and outcomes in 
wide format. The next step is to create the remaining variables required for the
`tvma` function and then begin our analysis.

The function still requires 2 more variables that we have not yet created:

1. `treatment` A binary vector with treatment schedule
2. `t.seq` The time sequence of the measures.

We can create these variables in the following way:
```{r}
treatment <- as.numeric(unique(smoker[ , c("SubjectID","varenicline")])[ , 2])-1
treatment
t.seq <- sort(unique(smoker$timeseq))
t.seq
```

Note that for `treatment` we looked at only one instance of each subject's 
response for varenicline, converted it to a numeric value, and subtracted 1 to 
yield a vector of zeros and ones. Similarly, to generate `t.seq` we found only
one instance of each time point and then sorted from smallest to largest.

We are now ready to perform our time varying mediation analysis.
```{r, fig.width = 7, fig.height = 5, results='hide', fig.keep='all'} 
results <- tvma(treatment, t.seq, mediator, outcome)
```
```{r, echo = FALSE}
results
```

The `tvma` function returns a list of results including:

1. `hat.alpha.1` the estimated effect of the intervention on the mediator 
2. `hat.beta.2` the estimated effect of the mediator on the outcome
3. `mediation effect` the time varying mediation effect
4. `sd` the estimated standard deviations of the mediation effect
5. `CI` the upper and lower confidence intervals

Note that the `sd` is only returned when asymptotic confidence intervals are 
computed. 

The function also generated a plot of the mediation effect and the bootstrapped
confidence intervals. We recommend using the plot to interpret your findings as
it may be difficult to derive meaning from the numerical values alone.
In the above plot, the effect of varenicline on cessation fatigue that is 
mediated by the negative mood is weaker than the effect of using the patch only. 
This effect decreases rapidly in the first week and then increases after day 8. 
Beyond 2 weeks the effect begins to plateau. Given that the confidence intervals 
do not cross zero, we can conclude that this effect is significant.

`tvma` accepts additional input arguments that allow the user to perform 
different analyses. 

1. `t.est` can be specified to select only certain time points at which to make the estimations.
2. `replicates` can be set to any number to specify the number of bootstrap replicates to compute. The default value is 1000

For example, specifying `t.est`, and `replicates` in the follow code will produce 
estimates as time points 0.2, 0.4, 0.6, and 0.8 using 500 bootsrap replicates.
```{r, fig.width = 6, fig.height = 4, results = 'hide', fig.keep = 'all'}
results <- tvma(treatment, t.seq, mediator, outcome, t.est = c(0.2, 0.4, 0.6, 0.8), replicates = 500)
```
```{r, echo = FALSE}
results
```

The `tvma` function computes bootstrap confidence intervals by default.

```{r, eval=FALSE, echo = FALSE, fig.width = 6, fig.height = 4, results = 'hide', fig.keep = 'all'}
# but 
# another powerful option for computing confidence intervals and standard 
# deviations exists.
# 
# 3. Declaring `CI = asymptotic` provides an alternative method for deriving confidence intervals.
# 
# Importantly, this process can be time intensive depending on the size of your 
# dataset. For the `smoker` dataset, this process will take approximately 45 min.
results <- tvma(treatment, t.seq, mediator, outcome, CI = "asymptotic")
```
```{r, eval=FALSE, echo = FALSE}
results
```

## Summary
The `tvmediation` package provides a powerful set of functions for estimating 
mediation effects that vary over time. Development of this tool has widespread
application for use in human behavior research, clinical trials, addiction 
research, and others. By adopting the Time Varying Mediation Analysis for your
data, we hope to characterize the realistic nature of an effect over time as 
opposed to the traditional approach of estimating an effect based on its single
occurrence. 

</div>

---
